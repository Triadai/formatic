<!DOCTYPE html><html lang="en"><head><title>default/eval</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="default/eval"><meta name="groc-project-path" content="lib/default/eval.js"><meta name="groc-github-url" content="https://github.com/zapier/formatic"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/zapier/formatic/blob/master/lib/default/eval.js">lib/default/eval.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="eval">eval</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The eval plugin will evaluate a field&#39;s <code>eval</code> property (which must be an
object) and exchange the properties of that object for whatever the
expression returns. Expressions are just JSON except if the first element of
an array is a string that starts with &#39;@&#39;. In that case, the array is
treated as a Lisp expression where the first element refers to a function
that is called with the rest of the elements as the arguments. For example:</p>
<pre><code class="lang-js">[<span class="hljs-string">'@sum'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>]</code></pre>
<p>will return the value 3. The expression could be used in an <code>eval</code> property of
a field like:</p>
<pre><code class="lang-js">{
  type: <span class="hljs-string">'string'</span>,
  key: <span class="hljs-string">'name'</span>,
  <span class="hljs-built_in">eval</span>: {
    rows: [<span class="hljs-string">'@sum'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>]
  }
}</code></pre>
<p>The <code>rows</code> property of the field would be set to 3 in this case.</p>
<p>Any plugin registered with the prefix <code>eval-function.</code> will be available as a
function in these expressions.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-pi">
'use strict'</span>;

<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>);

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(plugin)</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Grab all the function plugins.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> evalFunctionPlugins = plugin.requireAllOf(<span class="hljs-string">'eval-function'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Just strip off the &#39;eval-functions.&#39; prefix and put in a different object.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> functions = {};
  _.each(evalFunctionPlugins, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn, name)</span> {</span>
    <span class="hljs-keyword">var</span> fnName = name.substring(name.indexOf(<span class="hljs-string">'.'</span>) + <span class="hljs-number">1</span>);
    functions[fnName] = fn;
  });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check an array to see if it&#39;s a function expression.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> isFunctionArray = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(array)</span> {</span>
    <span class="hljs-keyword">return</span> array.length &gt; <span class="hljs-number">0</span> &amp;&amp; array[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] === <span class="hljs-string">'@'</span>;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Evaluate a function expression and return the result.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> evalFunction = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fnArray, field)</span> {</span>
    <span class="hljs-keyword">var</span> fnName = fnArray[<span class="hljs-number">0</span>].substring(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> functions[fnName](fnArray.slice(<span class="hljs-number">1</span>), field);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">if</span> (!(fnName <span class="hljs-keyword">in</span> functions)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Eval function '</span> + fnName + <span class="hljs-string">' not defined.'</span>);
      }
      <span class="hljs-keyword">throw</span> e;
    }
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Evaluate an expression in the context of a field.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> evaluate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(expression, field)</span> {</span>
    <span class="hljs-keyword">if</span> (_.isArray(expression)) {
      <span class="hljs-keyword">if</span> (isFunctionArray(expression)) {
        <span class="hljs-keyword">return</span> evalFunction(expression, field);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> expression.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> {</span>
          <span class="hljs-keyword">return</span> evaluate(item, field);
        });
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.isObject(expression)) {
      <span class="hljs-keyword">var</span> obj = {};
      <span class="hljs-built_in">Object</span>.keys(expression).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
        <span class="hljs-keyword">var</span> result = evaluate(expression[key], field);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> result !== <span class="hljs-string">'undefined'</span>) {
          obj[key] = result;
        }
      });
      <span class="hljs-keyword">return</span> obj;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> expression;
    }
  };

  plugin.exports.evaluate = evaluate;
};</div></div></div></div></body></html>