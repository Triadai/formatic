<!DOCTYPE html><html lang="en"><head><title>core/field</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="core/field"><meta name="groc-project-path" content="lib/core/field.js"><meta name="groc-github-url" content="https://github.com/zapier/formatic"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/zapier/formatic/blob/master/lib/core/field.js">lib/core/field.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="corefield">core.field</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The core field plugin provides the Field prototype. Fields represent a
particular state in time of a field definition, and they provide helper methods
to notify the form store of changes.</p>
<p>Fields are lazily created and evaluated, but once evaluated, they should be
considered immutable.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-pi">
'use strict'</span>;

<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>);

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(plugin)</span> {</span>

  <span class="hljs-keyword">var</span> router = plugin.require(<span class="hljs-string">'field-router'</span>);
  <span class="hljs-keyword">var</span> util = plugin.require(<span class="hljs-string">'util'</span>);
  <span class="hljs-keyword">var</span> evaluator = plugin.require(<span class="hljs-string">'eval'</span>);
  <span class="hljs-keyword">var</span> compiler = plugin.require(<span class="hljs-string">'compiler'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The Field constructor.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> Field = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(form, def, value, parent)</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    field.form = form;
    field.def = def;
    field.value = value;
    field.parent = parent;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Attach a field factory to the form prototype.</p></div></div><div class="code"><div class="wrapper">  plugin.exports.field = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> form = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Field(form, {
      type: <span class="hljs-string">'root'</span>
    }, form.store.value);
  };

  <span class="hljs-keyword">var</span> proto = Field.prototype;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Return the type plugin for this field.</p></div></div><div class="code"><div class="wrapper">  proto.typePlugin = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span> (!field._typePlugin) {
      field._typePlugin = plugin.require(<span class="hljs-string">'type.'</span> + field.def.type);
    }

    <span class="hljs-keyword">return</span> field._typePlugin;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get a component for this field.</p></div></div><div class="code"><div class="wrapper">  proto.component = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> component = router.componentForField(field);
    <span class="hljs-keyword">return</span> component({
      field: field
    });
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the child fields for this field.</p></div></div><div class="code"><div class="wrapper">  proto.fields = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span> (!field._fields) {
      <span class="hljs-keyword">var</span> fields;
      <span class="hljs-keyword">if</span> (field.typePlugin().fields) {
        fields = field.typePlugin().fields(field);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (field.def.fields) {
        fields = field.def.fields.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(def)</span> {</span>
          <span class="hljs-keyword">return</span> field.createChild(def);
        });
      } <span class="hljs-keyword">else</span> {
        fields = [];
      }
      field._fields = fields;
    }

    <span class="hljs-keyword">return</span> field._fields;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the items (child field definitions) for this field.</p></div></div><div class="code"><div class="wrapper">  proto.items = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span> (!field._items) {
      <span class="hljs-keyword">if</span> (_.isArray(field.def.items)) {
        field._items = field.def.items.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> {</span>
          <span class="hljs-keyword">return</span> field.resolve(item);
        });
      } <span class="hljs-keyword">else</span> {
        field._items = [];
      }
    }

    <span class="hljs-keyword">return</span> field._items;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Resolve a field reference if necessary.</p></div></div><div class="code"><div class="wrapper">  proto.resolve = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(def)</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span> (_.isString(def)) {
      def = field.form.findDef(def);
      <span class="hljs-keyword">if</span> (!def) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Could not find field: '</span> + def);
      }
    }

    <span class="hljs-keyword">return</span> def;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Evaluate a field definition and return a new field definition.</p></div></div><div class="code"><div class="wrapper">  proto.evalDef = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(def)</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span> (def.eval) {

      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">var</span> extDef = field.eval(def.eval);
        <span class="hljs-keyword">if</span> (extDef) {
          def = _.extend({}, def, extDef);
          def = compiler.compileDef(def);
        }
      } <span class="hljs-keyword">catch</span> (e) {
        console.log(<span class="hljs-string">'Problem in eval: '</span>, <span class="hljs-built_in">JSON</span>.stringify(def.eval));
        console.log(e.message);
      }
    }

    <span class="hljs-keyword">return</span> def;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Evaluate an expression in the context of a field.</p></div></div><div class="code"><div class="wrapper">  proto.eval = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(expression)</span> {</span>
    <span class="hljs-keyword">return</span> evaluator.evaluate(expression, <span class="hljs-keyword">this</span>);
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create a child field from a definition.</p></div></div><div class="code"><div class="wrapper">  proto.createChild = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(def)</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    def = field.resolve(def);

    <span class="hljs-keyword">var</span> value = field.value;

    def = field.evalDef(def);

    <span class="hljs-keyword">if</span> (!util.isBlank(def.key)) {
      <span class="hljs-keyword">if</span> (value &amp;&amp; !_.isUndefined(value[def.key])) {
        value = value[def.key];
      } <span class="hljs-keyword">else</span> {
        value = <span class="hljs-literal">undefined</span>;
      }
    } <span class="hljs-keyword">else</span> {
      value = def.value;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Field(field.form, def, value, field);
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Given a value, find an appropriate field definition for this field.</p></div></div><div class="code"><div class="wrapper">  proto.itemForValue = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">var</span> item = _.find(field.items(), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> {</span>
      <span class="hljs-keyword">return</span> util.itemMatchesValue(item, value);
    });
    <span class="hljs-keyword">if</span> (item) {
      item = _.extend({}, item);
    } <span class="hljs-keyword">else</span> {
      item = util.fieldDefFromValue(value);
    }

    <span class="hljs-keyword">return</span> item;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Walk backwards through parents and build out a path array to the value.</p></div></div><div class="code"><div class="wrapper">  proto.valuePath = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(childPath)</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">var</span> path = childPath || [];
    <span class="hljs-keyword">if</span> (!util.isBlank(field.def.key)) {
      path = [field.def.key].concat(path);
    }
    <span class="hljs-keyword">if</span> (field.parent) {
      <span class="hljs-keyword">return</span> field.parent.valuePath(path);
    }
    <span class="hljs-keyword">return</span> path;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set the value for this field.</p></div></div><div class="code"><div class="wrapper">  proto.val = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    field.form.actions.setValue(field.valuePath(), value);
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Remove a child value from this field.</p></div></div><div class="code"><div class="wrapper">  proto.remove = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">var</span> path = field.valuePath().concat(key);

    field.form.actions.removeValue(path);
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Move a child value from one key to another.</p></div></div><div class="code"><div class="wrapper">  proto.move = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fromKey, toKey)</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    field.form.actions.moveValue(field.valuePath(), fromKey, toKey);
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the default value for this field.</p></div></div><div class="code"><div class="wrapper">  proto.default = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span> (!_.isUndefined(field.def.value)) {
      <span class="hljs-keyword">return</span> util.copyValue(field.def.value);
    }

    <span class="hljs-keyword">if</span> (!_.isUndefined(field.def.default)) {
      <span class="hljs-keyword">return</span> util.copyValue(field.def.default);
    }

    <span class="hljs-keyword">if</span> (!_.isUndefined(field.typePlugin().default)) {
      <span class="hljs-keyword">return</span> util.copyValue(field.typePlugin().default);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Append a new value. Use the <code>itemIndex</code> to get an appropriate
item, inflate it, and create a default value.</p></div></div><div class="code"><div class="wrapper">  proto.append = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(itemIndex)</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">var</span> item = field.items()[itemIndex];
    item = _.extend(item);

    item.key = field.value.length;

    <span class="hljs-keyword">var</span> child = field.createChild(item);

    <span class="hljs-keyword">var</span> obj = child.default();

    <span class="hljs-keyword">if</span> (_.isArray(obj) || _.isObject(obj)) {
      <span class="hljs-keyword">var</span> chop = field.valuePath().length + <span class="hljs-number">1</span>;

      child.inflate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path, value)</span> {</span>
        obj = util.setIn(obj, path.slice(chop), value);
      });
    }

    field.form.actions.appendValue(field.valuePath(), obj);
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Determine whether the field is hidden.</p></div></div><div class="code"><div class="wrapper">  proto.hidden = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> field.def.hidden || field.typePlugin().hidden;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Expand all child fields and call the setter function with the default
values at each path.</p></div></div><div class="code"><div class="wrapper">  proto.inflate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(onSetValue)</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span> (!util.isBlank(field.def.key) &amp;&amp; _.isUndefined(field.value)) {
      onSetValue(field.valuePath(), field.default());
    }

    <span class="hljs-keyword">var</span> fields = field.fields();

    fields.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(child)</span> {</span>
      child.inflate(onSetValue);
    });
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Called from unmount. When fields are removed for whatever reason, we
should delete the corresponding value.</p></div></div><div class="code"><div class="wrapper">  proto.erase = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">if</span> (!util.isBlank(field.def.key) &amp;&amp; !_.isUndefined(field.value)) {
      field.form.actions.eraseValue(field.valuePath(), {});
    }
  };
};</div></div></div></div></body></html>