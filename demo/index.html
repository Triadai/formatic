<!DOCTYPE html>
<html>
<head>
  <link href="./style/formatic.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="./bower_components/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="./bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
</head>
<body>
  <div class="container-fluid">
    <div id="user"></div>
    <div id="extra"></div>
    <div id="json"></div>
  </div>

  <script src="./bower_components/jquery/dist/jquery.min.js"></script>
  <script src="./bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

  <script src="./lib/formatic.js"></script>
  <script>
    var formatic = require('formatic').create('default', 'bootstrap');

    var form = formatic([
      {
        label: 'Short Name',
        type: 'object',
        key: 'name',
        fields: ['firstName', 'lastName', {extends: 'nameType', value: 'short'}, 'silly'],
        match: {type: 'short'}
      },
      {
        label: 'Home Address',
        type: 'object',
        key: 'address_home',
        fields: ['address']
      },
      {
        label: 'Work Address',
        type: 'object',
        key: 'address_work',
        fields: ['address']
      },
      {
        label: 'Other Addresses',
        type: 'object',
        key: 'addresses_other',
        items: ['address']
      },
      {
        label: 'Do you like cookies?',
        type: 'boolean',
        key: 'likesCookies'
      },
      {
        label: 'Colors',
        type: 'array',
        key: 'colors',
        choices: ['red', 'green', 'blue']
      },
      {
        template: true,
        label: 'First Name',
        id: 'firstName',
        type: 'string',
        key: 'first',
        maxRows: 1,
        helpText: 'The name your momma calls you.'
      },
      {
        template: true,
        label: 'Last Name',
        id: 'lastName',
        type: 'string',
        key: 'last',
        maxRows: 1,
        when: [
          'firstName'
        ]
      },
      {
        template: true,
        type: 'string',
        hidden: true,
        id: 'nameType',
        key: 'type'
      },
      {
        template: true,
        type: 'array',
        label: 'Silly',
        id: 'silly',
        choices: [],
        eval: {
          choices: "if( aliases filter( map( slice(aliases 0 __index) fn([alias] get(alias 'first')) ) fn([alias] alias) ) )"
        }
      },
      {
        type: 'array',
        key: 'aliases',
        items: ['name', 'fullName']
      },
      {
        template: true,
        id: 'address',
        label: 'Address',
        type: 'object',
        fields: ['country', 'state', 'city']
      },
      {
        template: true,
        label: 'Country',
        type: 'string',
        key: 'country',
        choices: [],
        eval: {
          choices: "lookup( 'locations' )"
        }
      },
      {
        template: true,
        label: 'State',
        type: 'string',
        key: 'state',
        choices: {},
        eval: {
          choices: "lookup( 'locations' country)"
        }
      },
      {
        template: true,
        label: 'City',
        type: 'string',
        key: 'city',
        choices: [],
        eval: {
          choices: "lookup( 'locations' country state)"
        }
      },
      {
        template: true,
        label: 'Full Name',
        type: 'object',
        key: 'fullName',
        fields: ['firstName', 'middleName', 'lastName', {extends: 'nameType', value: 'full'}, , 'city'],
        match: {type: 'full'}
      },
      {
        template: true,
        label: 'Middle Name',
        id: 'middleName',
        type: 'string',
        key: 'middle',
        maxRows: 1
      }

      /*
      {
        label: 'Short Name',
        type: 'object',
        key: 'name',
        fields: ['firstName', 'lastName', 'nameType'],
        match: [
          {key: 'type', value: 'short'}
        ]
      },
      {
        type: 'object',
        key: 'address_home',
        fields: ['city']
      },
      {
        type: 'object',
        key: 'address_work',
        fields: ['city']
      },
      {
        type: 'array',
        key: 'aliases',
        items: ['name', 'fullName']
      },
      {
        type: 'json',
        key: 'blob',
        rows: 6
      },
      {
        template: true,
        label: 'City',
        type: 'string',
        key: 'city',
        data: {
          choices: 'cities'
        }
      },
      {
        template: true,
        type: 'string',
        hidden: true,
        id: 'nameType',
        key: 'type'
      },
      {
        template: true,
        label: 'Full Name',
        type: 'object',
        key: 'fullName',
        fields: ['firstName', 'middleName', 'lastName', 'nameType', 'reverseName', 'city', 'reverser'],
        match: [
          {key: 'type', value: 'full'}
        ]
      },
      {
        template: true,
        label: 'First Name',
        id: 'firstName',
        type: 'string',
        key: 'first',
        maxRows: 1,
        helpText: 'The name your momma calls you.'
      },
      {
        template: true,
        label: 'Last Name',
        id: 'lastName',
        type: 'string',
        key: 'last',
        maxRows: 1,
        when: [
          'firstName'
        ]
      },
      {
        template: true,
        label: 'Middle Name',
        id: 'middleName',
        type: 'string',
        key: 'middle',
        maxRows: 1
      },
      {
        template: true,
        label: 'Reverse Name',
        id: 'reverseName',
        type: 'string',
        key: 'reverse',
        maxRows: 1,
        data: {
          value: 'reverser'
        },
        when: [
          'reverser'
        ]
      },
      {
        template: true,
        id: 'reverser',
        type: 'data'
      },
      {
        id: 'cities',
        type: 'data',
        default: []
      },
      {
        id: 'reversedNames',
        type: 'data',
        default: {}
      }
      */
    ]);

    form.source('locations', function (country, state) {
      return new Promise(function (resolve, reject) {
        setTimeout(function () {
          if (country && state) {

            return resolve({
              us: {
                'us:mo': ['St. Louis', 'Jefferson City'],
                'us:il': ['Chicago', 'Springfield']
              },
              ca: {
                'ca:on': ['Toronto']
              }
            }[country][state]);

          } else if (country) {

            return resolve({
              us: [
                {
                  value: 'us:mo',
                  label: 'Missouri'
                },
                {
                  value: 'us:il',
                  label: 'Illinois'
                }
              ],
              ca: [
                {
                  value: 'ca:on',
                  label: 'Ontario'
                }
              ]
            }[country]);

          } else {

            return resolve([
              {
                value: 'us',
                label: 'United States'
              },
              {
                value: 'ca',
                label: 'Canada'
              }
            ]);
          }

          return reject('crap');
        }, 100)

      });

    });

    // var loadReverse = function (name) {
    //   if (name) {
    //
    //     var reversedNamesField = form.find('reversedNames');
    //
    //     if (!reversedNamesField.hasValAt(name)) {
    //       //form.find('reversedNames').valAt(name, 'loading...');
    //       setTimeout(function () {
    //
    //         console.log('writing...:', name)
    //         //reversedNamesField.valAt(name, name.split('').reverse().join(''));
    //
    //       }, 1000);
    //     }
    //   }
    // };
    //
    // formatic.source('reverser', function (field) {
    //
    //   var firstNameField = field.find('firstName');
    //   if (firstNameField) {
    //     var firstName = firstNameField.val();
    //     if (firstName) {
    //
    //       console.log('reading...')
    //       var reversedNamesField = form.find('reversedNames');
    //
    //       if (reversedNamesField.hasValAt(firstName)) {
    //         return reversedNamesField.valAt(firstName);
    //       } else {
    //         loadReverse(firstName);
    //       }
    //     }
    //   }
    //   return '';
    // });

    // var loadReverse = function (name) {
    //   if (name) {
    //     setTimeout(function () {
    //       var reverseNamesField = form.find('reverseNames');
    //
    //       var valueCursor = reverseNamesField.valCursor();
    //
    //       valueCursor.set(name, name.split('').reverse().join(''));
    //     }, 1000);
    //   }
    // };
    //
    // formatic.source('reverser', function (field) {
    //
    //   var firstNameField = field.find('firstName');
    //   if (firstNameField) {
    //     var firstName = firstNameField.val();
    //     if (firstName) {
    //       var reverseNamesField = form.find('reverseNames');
    //       var valueCursor = reverseNamesField.valCursor();
    //       if (valueCursor.has(firstName)) {
    //         return valueCursor.get(firstName);
    //       }
    //     }
    //   }
    //   return '';
    // });

    form.attach(document.getElementById('user'));
  </script>
</body>
</html>
