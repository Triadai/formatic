<!DOCTYPE html>
<html>
<head>
  <link href="./style/formatic.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="./bower_components/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="./bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
</head>
<body>
  <div class="container-fluid">
    <div id="user"></div>
    <div id="extra"></div>
    <div id="json"></div>
    <div style="height:200px"></div>
  </div>

  <script src="./bower_components/jquery/dist/jquery.min.js"></script>
  <script src="./bower_components/underscore/underscore-min.js"></script>
  <script src="./bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="./bower_components/react/react-with-addons.js"></script>

  <script src="./lib/formatic.js"></script>
  <script>

    var FormClass = Formatic.config({
      component: {
        props: ['bootstrap-style']
      }
    });

    var form = FormClass.form({
      fields: [
        {
          label: 'Short Name',
          type: 'fieldset',
          key: 'name',
          fields: ['firstName', 'lastName', {extends: 'nameType', value: 'short'}, 'silly'],
          match: {type: 'short'}
        },
        {
          label: 'Home Address',
          type: 'fieldset',
          key: 'address_home',
          extends: 'address',
          group: 'addresses',
          eval: {
            context: {
              countryMessage: 'Your native land.'
            }
          }
        },
        {
          label: 'Work Address',
          type: 'fieldset',
          key: 'address_work',
          extends: 'address',
          eval: {
            context: {
              countryMessage: 'Your working land.'
            }
          }
        },
        {
          label: 'Other Addresses',
          type: 'fieldset',
          key: 'addresses_other',
          items: ['address']
        },
        {
          label: 'Do you like cookies?',
          type: 'boolean',
          key: 'likesCookies'
        },
        {
          label: 'Colors',
          type: 'array',
          key: 'colors',
          choices: ['red', 'green', 'blue']
        },
        {
          label: 'Foods',
          type: 'array',
          key: 'foods',
          choices: [
            {value: 'tacos', label: 'Tacos', sample: 'Some sample'},
            {value: 'burritos', label: 'Burritos', sample: 'Another sample'},
            {value: 'enchiladas', label: 'Enchiladas', sample: 'Tasty sample'}
          ]
        },
        {
          template: true,
          label: 'First Name',
          id: 'firstName',
          type: 'unicode',
          key: 'first',
          help_text: 'The name your momma calls you.'
        },
        {
          template: true,
          label: 'Last Name',
          id: 'lastName',
          type: 'string',
          key: 'last',
          maxRows: 1,
          when: [
            'firstName'
          ]
        },
        {
          template: true,
          type: 'unicode',
          hidden: true,
          id: 'nameType',
          key: 'type'
        },

        //{key: 'watchedField', match: 'exact', value: 'ok changed', action: 'hide'}
        {
          template: true,
          type: 'string',
          label: 'Silly',
          id: 'silly',
          eval: {
            //hidden: ['@if', ['@not', ['@getIn', 'name', 'first']], true, false]
            //value: ['@if']['@sum', 1, 1]
            //value: ['@get', 'likesCookies']
            hidden: ['@not', ['@get', 'likesCookies']]//,
            // needsMeta: ['@if',
            //   ['get', 'country'],
            //   {source: 'location', params: {country: ['@get', 'country']}}
            // ]
          }
          // eval: {
          //   choices: getAll(firstName, 'alias')
          //   choices: lookup('location', country)
          //   choices: {call: 'lookup', args: ['']}
          //   hidden: {}
          // }
          // when: {test: 'eq', },
          // choices: [],
          // eval: {
          //   choices: "if( aliases filter( map( slice(aliases 0 __index) fn([alias] get(alias 'first')) ) fn([alias] alias) ) )"
          // }
        },
        {
          type: 'array',
          key: 'aliases',
          items: ['name', 'fullName']
        },
        {
          template: true,
          id: 'address',
          label: 'Address',
          type: 'fieldset',
          fields: ['country', 'state', 'city'],
          collapsed: true
        },
        {
          template: true,
          label: 'Country',
          type: 'string',
          key: 'country',
          choices: [],
          lookup: {source: 'locations'},
          eval: {
            help_text: ['@get', 'countryMessage'],
          }
          // eval: {
          //   needsMeta: [
          //     ['@if', ['@getMeta', 'locations'], null, ['locations']]
          //   ],
          //   choices: ['@getMeta', 'locations']
          // }
        },

        {
          template: true,
          label: 'State',
          type: 'string',
          key: 'state',
          choices: [],
          lookup: {source: 'locations', keys: ['country']}
          // eval: {
          //   needsMeta: [
          //     ['@if', ['@getMeta', 'locations', {country: ['@get', 'country']}], null, ['locations', {country: ['@get', 'country']}]]
          //   ],
          //   choices: ['@getMeta', 'locations', {country: ['@get', 'country']}]
          // }
        },
        {
          template: true,
          label: 'City',
          type: 'string',
          key: 'city',
          choices: [],
          lookup: {source: 'locations', keys: ['country', 'state']}
          // eval: {
          //   needsMeta: [
          //     ['@if', ['@getMeta', 'locations', {country: ['@get', 'country'], state: ['@get', 'state']}], null, ['locations', {country: ['@get', 'country'], state: ['@get', 'state']}]]
          //   ],
          //   choices: ['@getMeta', 'locations', {country: ['@get', 'country'], state: ['@get', 'state']}]
          // }
        },
        {
          template: true,
          label: 'Full Name',
          type: 'fieldset',
          key: 'fullName',
          group: 'fullNames',
          fields: ['firstName', 'middleName', 'lastName', {extends: 'nameType', value: 'full'}, {extends: 'address', key: 'address'}, 'crazy', 'pretty'],
          match: {type: 'full'},
          collapsed: true,
          help_text: "What is going on here???"
        },
        {
          template: true,
          label: 'Middle Name',
          id: 'middleName',
          type: 'string',
          key: 'middle',
          maxRows: 1
        },
        {
          template: true,
          label: 'Crazy',
          key: 'crazy',
          type: 'array',
          choices: [],
          lookup: {source: 'names', keys: ['first'], group: 'fullNames'}
          // eval: {
          //   needsMeta: [
          //     '@forEach', 'alias', ['@getGroupValues', 'fullNames'],
          //     ['names', {first: ['@get', 'alias', 'first']}],
          //     ['@not', ['@getMeta', 'names', {first: ['@get', 'alias', 'first']}]],
          //   ],
          //   choices: [
          //     '@forEach', 'alias', ['@getGroupValues', 'fullNames'],
          //     ['@getMeta', 'names', {first: ['@get', 'alias', 'first']}],
          //     ['@getMeta', 'names', {first: ['@get', 'alias', 'first']}]
          //   ]
          // }
        },
        {
          label: 'Some Blob',
          key: 'blob',
          type: 'json',
          default: {foo:'bar'}
        },
        {
          label: 'Pretty Stuff',
          key: 'pretty',
          type: 'string',
          //replaceChoices: {'long':'Some Long Label','some_shorty':'Short'}
          lookupReplacements: {source: 'locations'}
        },
        // {
        //   label: 'Other Pretty Stuff',
        //   key: 'pretty2',
        //   type: 'string',
        //   //replaceChoices: {'long':'Some Long Label','some_shorty':'Short'}
        //   lookupReplacements: {source: 'locations', keys: ['country'], group: 'addresses'}
        // },
        {
          label: 'Mirror',
          type: 'json',
          eval: {
            value: ['@join', ['@reverse', ['@split', ['@or', '=pretty', ''], '']], '']
          }
        },
        {
          label: 'Dynamic Fields',
          type: 'fieldset',
          key: 'dynamicFields',
          eval: {
            fields: [
              '@forEach', 'param', ['foo', 'bar'],
                {key: '=param', label: '=param', extends: 'address'}
            ]
          }
        },
        {
          label: 'Age',
          type: 'number',
          key: 'age'
        },
        {
          label: 'Map',
          type: 'dict',
          key: 'myMap'
        },
        {
          label: 'Null Junk',
          type: 'null',
          key: 'nullJunk'
        },
        {
          label: 'Guess',
          key: 'guess',
          type: 'array'
        }
      ]
    });

    form.source('locations', function (params) {

      var country = params.country;
      var state = params.state;
      return new Promise(function (resolve, reject) {
        setTimeout(function () {
          if (country && state) {

            return resolve({
              us: {
                'us:mo': ['St. Louis', 'Jefferson City'],
                'us:il': ['Chicago', 'Springfield']
              },
              ca: {
                'ca:on': ['Toronto']
              }
            }[country][state] || []);

          } else if (country) {

            return resolve({
              us: [
                {
                  value: 'us:mo',
                  label: 'Missouri'
                },
                {
                  value: 'us:il',
                  label: 'Illinois'
                }
              ],
              ca: [
                {
                  value: 'ca:on',
                  label: 'Ontario'
                }
              ]
            }[country] || []);

          } else {

            //return reject('crap');

            return resolve([
              {
                value: 'us',
                label: 'United States',
                sample: 'Star Spangled Banner!'
              },
              {
                value: 'ca',
                label: 'Canada',
                sample: 'O Canada!'
              },
              {
                value: 'foo',
                label: 'Foo',
                sample: 'Foolander!'
              },
              {
                value: 'boo',
                label: 'Boo',
                sample: 'Boolander!'
              },
              {
                value: 'zoo',
                label: 'Zoo',
                sample: 'Zoolander!'
              },
              {
                value: 'qoo',
                label: 'Qoo',
                sample: 'Qoolander!'
              },
            ]);
          }

          return reject('crap');
        }, 2000)

      });

    });

    form.source('names', function (params) {
      return [params.first.toUpperCase()];
    });

    // var jsonForm = formatic({
    //   fields: [
    //     {
    //       type: 'json',
    //       key: 'value',
    //       label: 'Value of the other form up there',
    //       rows: 10
    //     }
    //   ]
    // });
    //
    // var component = form.component({
    //   onChange: function (value) {
    //     jsonForm.val({value: value});
    //   }
    // });
    //
    // var jsonComponent = jsonForm.component();

    var Form = React.createFactory(FormClass);

    var onFocus = function (event) {
      console.log('focus:', event.path, event.field);
    };

    var onBlur = function (event) {
      console.log('blur:', event.path, event.field);
    };

    React.render(Form({defaultForm: form, onFocus: onFocus, onBlur: onBlur}), document.getElementById('user'));

    //var formElement = React.createFactory()

    //formatic.render(jsonComponent, document.getElementById('json'));

  </script>
</body>
</html>
