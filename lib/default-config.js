'use strict';

var React = require('react/addons');
var _ = require('underscore');

var utils = require('./utils');

var createString = function () {
  return '';
};

var createObject = function () {
  return {};
};

module.exports = {

  // Field element factories
  createElement_Fields: React.createFactory(require('./components/fields/fields')),
  createElement_Text: React.createFactory(require('./components/fields/text')),
  createElement_Unicode: React.createFactory(require('./components/fields/unicode')),
  createElement_Select: React.createFactory(require('./components/fields/select')),
  createElement_PrettyTextarea: React.createFactory(require('./components/fields/pretty-textarea')),
  createElement_UnknownField: React.createFactory(require('./components/fields/unknown')),
  createElement_Copy: React.createFactory(require('./components/fields/copy')),

  // Other element factories
  createElement_Field: React.createFactory(require('./components/helpers/field')),
  createElement_Label: React.createFactory(require('./components/helpers/label')),
  createElement_Help: React.createFactory(require('./components/helpers/help')),
  createElement_Choices: React.createFactory(require('./components/helpers/choices')),

  // Field default values
  getDefaultValue_Fields: createObject,
  getDefaultValue_Text: createString,
  getDefaultValue_Unicode: createString,
  getDefaultValue_Select: createString,

  hasElementFactory: function (name) {
    var config = this;

    return config['createElement_' + name] ? true : false;
  },

  createElement: function (name, props, children) {
    var config = this;

    if (!props.config) {
      props = _.extend({}, props, {config: config});
    }

    name = config.getElementName(name);

    if (config['createElement_' + name]) {
      return config['createElement_' + name](props, children);
    }

    if (name !== 'Unknown') {
      if (config.hasElementFactory('Unknown')) {
        return config.createElement('Unknown', props, children);
      }
    }

    throw new Error('Factory not found for: ' + name);
  },

  createField: function (props) {
    var config = this;

    var name = config.getFieldTypeName(props.field);

    if (config.hasElementFactory(name)) {
      return config.createElement(name, props);
    }

    return config.createElement('UnknownField', props);
  },

  getElementName: function (name) {
    return utils.dashToPascal(name);
  },

  alias_Dict: 'Object',

  // Field helpers
  getFieldTypeName: function (field) {
    var config = this;

    var fieldType = utils.dashToPascal(field.type);

    var alias = config['alias_' + fieldType];

    if (alias) {
      if (_.isFunction(alias)) {
        return alias(field);
      } else {
        return alias;
      }
    }

    if (field.list) {
      fieldType = 'List';
    }

    return fieldType;
  },
  getFieldDefaultValue: function (field) {
    var config = this;

    var typeName = config.getFieldTypeName(field);

    if (config['getDefaultValue_' + typeName]) {
      return config['getDefaultValue_' + typeName](field);
    }

    return '';
  },
  getFieldChoices: function (field) {
    var config = this;

    return config.normalizeChoices(field.choices);
  },
  getFieldReplaceChoices: function (field) {
    var config = this;

    return config.normalizeChoices(field.replaceChoices);
  },
  getFieldLabel: function (field) {
    return field.label;
  },
  getFieldHelpText: function (field) {
    return field.help_text_html || field.help_text || field.helpText || field.helpTextHtml;
  },

  // Other helpers
  humanize: function(property) {
    property = property.replace(/\{\{/g, '');
    property = property.replace(/\}\}/g, '');
    return property.replace(/_/g, ' ')
    .replace(/(\w+)/g, function(match) {
      return match.charAt(0).toUpperCase() + match.slice(1);
    });
  },

  normalizeChoices: function (choices) {
    var config = this;

    if (!choices) {
      return [];
    }

    // Convert comma separated string to array of strings.
    if (_.isString(choices)) {
      choices = choices.split(',');
    }

    // Convert object to array of objects with `value` and `label` properties.
    if (!_.isArray(choices) && _.isObject(choices)) {
      choices = Object.keys(choices).map(function (key) {
        return {
          value: key,
          label: choices[key]
        };
      });
    }

    // Copy the array of choices so we can manipulate them.
    choices = choices.slice(0);

    // Array of choice arrays should be flattened.
    choices = _.flatten(choices);

    choices.forEach(function (choice, i) {
      // Convert any string choices to objects with `value` and `label`
      // properties.
      if (_.isString(choice)) {
        choices[i] = {
          value: choice,
          label: config.humanize(choice)
        };
      }
      if (!choices[i].label) {
        choices[i].label = config.humanize(choices[i].value);
      }
    });

    return choices;
  }
};
