<!DOCTYPE html><html lang="en"><head><title>lib/mixins/resize</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="lib/mixins/resize"><meta name="groc-project-path" content="lib/mixins/resize.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/mixins/resize.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="resize-mixin">resize mixin</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>You'd think it would be pretty easy to detect when a DOM element is resized.
And you'd be wrong. There are various tricks, but none of them work very well.
So, using good ol' polling here. To try to be as efficient as possible, there
is only a single setInterval used for all elements. To use:</p>

<pre><code class="js">module.exports = React.createClass({

  mixins: [require('../../mixins/resize')],

  onResize: function () {
    console.log('resized!');
  },

  componentDidMount: function () {
    this.setOnResize('myText', this.onResize);
  },

  onChange: function () {
    ...
  },

  render: function () {
    return React.DOM.textarea({ref: 'myText', value: this.props.value, onChange: ...})
  }
});
</code></pre></div></div><div class="code"><div class="wrapper"><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">resizeIntervalElements</span> <span class="o">=</span> <span class="p">{};</span>
<span class="kd">var</span> <span class="nx">resizeIntervalElementsCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">resizeIntervalTimer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">checkElements</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">resizeIntervalElements</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">resizeIntervalElements</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">!==</span> <span class="nx">element</span><span class="p">.</span><span class="nx">__prevClientWidth</span> <span class="o">||</span> <span class="nx">element</span><span class="p">.</span><span class="nx">clientHeight</span> <span class="o">!==</span> <span class="nx">element</span><span class="p">.</span><span class="nx">__prevClientHeight</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">__prevClientWidth</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">;</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">__prevClientHeight</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">__resizeHandlers</span><span class="p">;</span>
      <span class="nx">handlers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">handler</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">},</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">addResizeIntervalHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">resizeIntervalTimer</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">resizeIntervalTimer</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="nx">checkElements</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;__resizeId&#39;</span> <span class="k">in</span> <span class="nx">element</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">id</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">__prevClientWidth</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">;</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">__prevClientHeight</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">;</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">__resizeId</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
    <span class="nx">resizeIntervalElementsCount</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">resizeIntervalElements</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">__resizeHandlers</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">}</span>
  <span class="nx">element</span><span class="p">.</span><span class="nx">__resizeHandlers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">removeResizeIntervalHandlers</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;__resizeId&#39;</span> <span class="k">in</span> <span class="nx">element</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">__resizeId</span><span class="p">;</span>
  <span class="k">delete</span> <span class="nx">element</span><span class="p">.</span><span class="nx">__resizeId</span><span class="p">;</span>
  <span class="k">delete</span> <span class="nx">element</span><span class="p">.</span><span class="nx">__resizeHandlers</span><span class="p">;</span>
  <span class="k">delete</span> <span class="nx">resizeIntervalElements</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
  <span class="nx">resizeIntervalElementsCount</span><span class="o">--</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">resizeIntervalElementsCount</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">resizeIntervalTimer</span><span class="p">);</span>
    <span class="nx">resizeIntervalTimer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">onResize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ref</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">fn</span><span class="p">(</span><span class="nx">ref</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>

  <span class="nx">componentDidMount</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onResizeWindow</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;resize&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onResizeWindow</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">resizeElementRefs</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">},</span>

  <span class="nx">componentWillUnmount</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onResizeWindow</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">&#39;resize&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onResizeWindow</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">resizeElementRefs</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">ref</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">removeResizeIntervalHandlers</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">refs</span><span class="p">[</span><span class="nx">ref</span><span class="p">].</span><span class="nx">getDOMNode</span><span class="p">());</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
  <span class="p">},</span>

  <span class="nx">setOnResize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ref</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">resizeElementRefs</span><span class="p">[</span><span class="nx">ref</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">resizeElementRefs</span><span class="p">[</span><span class="nx">ref</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">addResizeIntervalHandler</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">refs</span><span class="p">[</span><span class="nx">ref</span><span class="p">].</span><span class="nx">getDOMNode</span><span class="p">(),</span> <span class="nx">onResize</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">fn</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">};</span></div></div></div></div></body></html>