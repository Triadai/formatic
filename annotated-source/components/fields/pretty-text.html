<!DOCTYPE html><html lang="en"><head><title>components/fields/pretty-text</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="components/fields/pretty-text"><meta name="groc-project-path" content="lib/components/fields/pretty-text.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/components/fields/pretty-text.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="pretty-textarea-component">pretty-textarea component</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Textarea that will display highlights behind &quot;tags&quot;. Tags currently mean text
that is enclosed in braces like <code>{{foo}}</code>. Tags are replaced with labels if
available or humanized.</p>
<p>This component is quite complicated because:</p>
<ul>
<li>We are displaying text in the textarea but have to keep track of the real
text value in the background. We can&#39;t use a data attribute, because it&#39;s a
textarea, so we can&#39;t use any elements at all!</li>
<li>Because of the hidden data, we also have to do some interception of
copy, which is a little weird. We intercept copy and copy the real text
to the end of the textarea. Then we erase that text, which leaves the copied
data in the buffer.</li>
<li>React loses the caret position when you update the value to something
different than before. So we have to retain tracking information for when
that happens.</li>
<li>Because we monkey with copy, we also have to do our own undo/redo. Otherwise
the default undo will have weird states in it.</li>
</ul>
<p>So good luck!</p></div></div><div class="code"><div class="wrapper"><span class="hljs-pi">
'use strict'</span>;

<span class="hljs-keyword">var</span> React = <span class="hljs-built_in">require</span>(<span class="hljs-string">'react/addons'</span>);
<span class="hljs-keyword">var</span> R = React.DOM;
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>);
<span class="hljs-keyword">var</span> cx = React.addons.classSet;

<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../utils'</span>);

<span class="hljs-keyword">var</span> noBreak = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
  <span class="hljs-keyword">return</span> value.replace(<span class="hljs-regexp">/ /g</span>, <span class="hljs-string">'\u00a0'</span>);
};

<span class="hljs-keyword">var</span> LEFT_PAD = <span class="hljs-string">'\u00a0\u00a0'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Why this works, I&#39;m not sure.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> RIGHT_PAD = <span class="hljs-string">'  '</span>; <span class="hljs-comment">//'\u00a0\u00a0';</span>

<span class="hljs-keyword">var</span> idPrefixRegEx = <span class="hljs-regexp">/^[0-9]+__/</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Zapier specific stuff. Make a plugin for this later.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> removeIdPrefix = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
  <span class="hljs-keyword">if</span> (idPrefixRegEx.test(key)) {
    <span class="hljs-keyword">return</span> key.replace(idPrefixRegEx, <span class="hljs-string">''</span>);
  }
  <span class="hljs-keyword">return</span> key;
};

<span class="hljs-keyword">var</span> positionInNode = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(position, node)</span> </span>{
  <span class="hljs-keyword">var</span> rect = node.getBoundingClientRect();
  <span class="hljs-keyword">if</span> (position.x &gt;= rect.left &amp;&amp; position.x &lt;= rect.right) {
    <span class="hljs-keyword">if</span> (position.y &gt;= rect.top &amp;&amp; position.y &lt;= rect.bottom) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
  }
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Wrap a text value so it has a type. For parsing text with tags.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> textPart = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, type)</span> </span>{
  type = type || <span class="hljs-string">'text'</span>;
  <span class="hljs-keyword">return</span> {
    type: type,
    value: value
  };
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Parse text that has tags like {{tag}} into text and tags.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> parseTextWithTags = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
  value = value || <span class="hljs-string">''</span>;
  <span class="hljs-keyword">var</span> parts = value.split(<span class="hljs-regexp">/{{(?!{)/</span>);
  <span class="hljs-keyword">var</span> frontPart = [];
  <span class="hljs-keyword">if</span> (parts[<span class="hljs-number">0</span>] !== <span class="hljs-string">''</span>) {
    frontPart = [
    textPart(parts[<span class="hljs-number">0</span>])
    ];
  }
  parts = frontPart.concat(
    parts.slice(<span class="hljs-number">1</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(part)</span> </span>{
      <span class="hljs-keyword">if</span> (part.indexOf(<span class="hljs-string">'}}'</span>) &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> [
        textPart(part.substring(<span class="hljs-number">0</span>, part.indexOf(<span class="hljs-string">'}}'</span>)), <span class="hljs-string">'tag'</span>),
        textPart(part.substring(part.indexOf(<span class="hljs-string">'}}'</span>) + <span class="hljs-number">2</span>))
        ];
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> textPart(<span class="hljs-string">'{{'</span> + part, <span class="hljs-string">'text'</span>);
      }
    })
  );
  <span class="hljs-keyword">return</span> [].concat.apply([], parts);
};


<span class="hljs-built_in">module</span>.exports = React.createClass({

  displayName: <span class="hljs-string">'TaggedText'</span>,

  mixins: [<span class="hljs-built_in">require</span>(<span class="hljs-string">'../../mixins/field'</span>), <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../mixins/undo-stack'</span>), <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../mixins/resize'</span>)],</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>getDefaultProps: function () {
  return {
    className: plugin.config.className
  };</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-comment">// ,</span>

  getReplaceState: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(props)</span> </span>{
    <span class="hljs-keyword">var</span> replaceChoices = props.config.fieldReplaceChoices(props.field);
    <span class="hljs-keyword">var</span> replaceChoicesLabels = {};
    replaceChoices.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(choice)</span> </span>{
      replaceChoicesLabels[choice.value] = choice.label;
    });
    <span class="hljs-keyword">return</span> {
      replaceChoices: replaceChoices,
      replaceChoicesLabels: replaceChoicesLabels
    };
  },

  getInitialState: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> replaceState = <span class="hljs-keyword">this</span>.getReplaceState(<span class="hljs-keyword">this</span>.props);

    <span class="hljs-keyword">return</span> {
      undoDepth: <span class="hljs-number">100</span>,
      isChoicesOpen: <span class="hljs-literal">false</span>,
      hoverPillRef: <span class="hljs-literal">null</span>,
      replaceChoices: replaceState.replaceChoices,
      replaceChoicesLabels: replaceState.replaceChoicesLabels
    };
  },

  componentWillReceiveProps: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newProps)</span> </span>{
    <span class="hljs-keyword">this</span>.setState(<span class="hljs-keyword">this</span>.getReplaceState(newProps));
  },

  componentWillMount: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Not quite state, this is for tracking selection info.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">this</span>.tracking = {};

    <span class="hljs-keyword">var</span> parts = parseTextWithTags(<span class="hljs-keyword">this</span>.props.field.value);
    <span class="hljs-keyword">var</span> tokens = <span class="hljs-keyword">this</span>.tokens(parts);
    <span class="hljs-keyword">var</span> indexMap = <span class="hljs-keyword">this</span>.indexMap(tokens);

    <span class="hljs-keyword">this</span>.tracking.pos = indexMap.length;
    <span class="hljs-keyword">this</span>.tracking.range = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.tracking.tokens = tokens;
    <span class="hljs-keyword">this</span>.tracking.indexMap = indexMap;
  },

  getStateSnapshot: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> {
      value: <span class="hljs-keyword">this</span>.props.field.value,
      pos: <span class="hljs-keyword">this</span>.tracking.pos,
      range: <span class="hljs-keyword">this</span>.tracking.range
    };
  },

  setStateSnapshot: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(snapshot)</span> </span>{
    <span class="hljs-keyword">this</span>.tracking.pos = snapshot.pos;
    <span class="hljs-keyword">this</span>.tracking.range = snapshot.range;
    <span class="hljs-keyword">this</span>.onChangeValue(snapshot.value);
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Turn into individual characters and tags</p></div></div><div class="code"><div class="wrapper">  tokens: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(parts)</span> </span>{
    <span class="hljs-keyword">return</span> [].concat.apply([], parts.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(part)</span> </span>{
      <span class="hljs-keyword">if</span> (part.type === <span class="hljs-string">'tag'</span>) {
        <span class="hljs-keyword">return</span> part;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> part.value.split(<span class="hljs-string">''</span>);
      }
    }));
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Map each textarea index back to a token</p></div></div><div class="code"><div class="wrapper">  indexMap: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(tokens)</span> </span>{
    <span class="hljs-keyword">var</span> indexMap = [];
    _.each(tokens, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(token, tokenIndex)</span> </span>{
      <span class="hljs-keyword">if</span> (token.type === <span class="hljs-string">'tag'</span>) {
        <span class="hljs-keyword">var</span> label = LEFT_PAD + noBreak(<span class="hljs-keyword">this</span>.prettyLabel(token.value)) + RIGHT_PAD;
        <span class="hljs-keyword">var</span> labelChars = label.split(<span class="hljs-string">''</span>);
        _.each(labelChars, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          indexMap.push(tokenIndex);
        });
      } <span class="hljs-keyword">else</span> {
        indexMap.push(tokenIndex);
      }
    }.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">return</span> indexMap;
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Make highlight scroll match textarea scroll</p></div></div><div class="code"><div class="wrapper">  onScroll: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.refs.highlight.getDOMNode().scrollTop = <span class="hljs-keyword">this</span>.refs.content.getDOMNode().scrollTop;
    <span class="hljs-keyword">this</span>.refs.highlight.getDOMNode().scrollLeft = <span class="hljs-keyword">this</span>.refs.content.getDOMNode().scrollLeft;
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Given some postion, return the token index (position could be in the middle of a token)</p></div></div><div class="code"><div class="wrapper">  tokenIndex: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(pos, tokens, indexMap)</span> </span>{
    <span class="hljs-keyword">if</span> (pos &lt; <span class="hljs-number">0</span>) {
      pos = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pos &gt;= indexMap.length) {
      <span class="hljs-keyword">return</span> tokens.length;
    }
    <span class="hljs-keyword">return</span> indexMap[pos];
  },

  onChange: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
    <span class="hljs-comment">//console.log('change:', event.target.value);</span>

    <span class="hljs-keyword">var</span> node = event.target;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Tracking is holding previous position and range</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> prevPos = <span class="hljs-keyword">this</span>.tracking.pos;
    <span class="hljs-keyword">var</span> prevRange = <span class="hljs-keyword">this</span>.tracking.range;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>New position</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> pos = node.selectionStart;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Going to mutate the tokens.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> tokens = <span class="hljs-keyword">this</span>.tracking.tokens;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Using the previous position and range, get the previous token position
and range</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> prevTokenIndex = <span class="hljs-keyword">this</span>.tokenIndex(prevPos, tokens, <span class="hljs-keyword">this</span>.tracking.indexMap);
    <span class="hljs-keyword">var</span> prevTokenEndIndex = <span class="hljs-keyword">this</span>.tokenIndex(prevPos + prevRange, tokens, <span class="hljs-keyword">this</span>.tracking.indexMap);
    <span class="hljs-keyword">var</span> prevTokenRange = prevTokenEndIndex - prevTokenIndex;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Wipe out any tokens in the selected range because the change would have
erased that selection.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (prevTokenRange &gt; <span class="hljs-number">0</span>) {
      tokens.splice(prevTokenIndex, prevTokenRange);
      <span class="hljs-keyword">this</span>.tracking.indexMap = <span class="hljs-keyword">this</span>.indexMap(tokens);
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If cursor has moved forward, then text was added.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (pos &gt; prevPos) {
      <span class="hljs-keyword">var</span> addedText = node.value.substring(prevPos, pos);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Insert the text into the tokens.</p></div></div><div class="code"><div class="wrapper">      tokens.splice(prevTokenIndex, <span class="hljs-number">0</span>, addedText);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If cursor has moved backward, then we deleted (backspaced) text</p></div></div><div class="code"><div class="wrapper">    } <span class="hljs-keyword">if</span> (pos &lt; prevPos) {
      <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">this</span>.tokenAt(pos);
      <span class="hljs-keyword">var</span> tokenBefore = <span class="hljs-keyword">this</span>.tokenBefore(pos);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If we moved back onto a token, then we should move back to beginning
of token.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (token === tokenBefore) {
        pos = <span class="hljs-keyword">this</span>.moveOffTag(pos, tokens, <span class="hljs-keyword">this</span>.indexMap(tokens), -<span class="hljs-number">1</span>);
      }
      <span class="hljs-keyword">var</span> tokenIndex = <span class="hljs-keyword">this</span>.tokenIndex(pos, tokens, <span class="hljs-keyword">this</span>.tracking.indexMap);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Now we can remove the tokens that were deleted.</p></div></div><div class="code"><div class="wrapper">      tokens.splice(tokenIndex, prevTokenIndex - tokenIndex);
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Convert tokens back into raw value with tags. Newly formed tags will
become part of the raw value.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> rawValue = <span class="hljs-keyword">this</span>.rawValue(tokens);

    <span class="hljs-keyword">this</span>.tracking.pos = pos;
    <span class="hljs-keyword">this</span>.tracking.range = <span class="hljs-number">0</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set the value to the new raw value.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">this</span>.onChangeValue(rawValue);

    <span class="hljs-keyword">this</span>.snapshot();
  },

  componentDidUpdate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> value = <span class="hljs-keyword">this</span>.props.field.value || <span class="hljs-string">''</span>;
    <span class="hljs-keyword">var</span> parts = parseTextWithTags(value);
    <span class="hljs-keyword">this</span>.tracking.tokens = <span class="hljs-keyword">this</span>.tokens(parts);
    <span class="hljs-keyword">this</span>.tracking.indexMap = <span class="hljs-keyword">this</span>.indexMap(<span class="hljs-keyword">this</span>.tracking.tokens);

    <span class="hljs-keyword">var</span> pos = <span class="hljs-keyword">this</span>.normalizePosition(<span class="hljs-keyword">this</span>.tracking.pos);
    <span class="hljs-keyword">var</span> range = <span class="hljs-keyword">this</span>.tracking.range;
    <span class="hljs-keyword">var</span> endPos = <span class="hljs-keyword">this</span>.normalizePosition(pos + range);
    range = endPos - pos;

    <span class="hljs-keyword">this</span>.tracking.pos = pos;
    <span class="hljs-keyword">this</span>.tracking.range = range;

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.activeElement === <span class="hljs-keyword">this</span>.refs.content.getDOMNode()) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>React can lose the selection, so put it back.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">this</span>.refs.content.getDOMNode().setSelectionRange(pos, pos + range);
    }
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the label for a key.</p></div></div><div class="code"><div class="wrapper">  prettyLabel: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.replaceChoicesLabels[key]) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.state.replaceChoicesLabels[key];
    }
    <span class="hljs-keyword">var</span> cleaned = removeIdPrefix(key);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.props.config.humanize(cleaned);
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Given the actual value of the field (with tags), get the plain text that
should show in the textarea.</p></div></div><div class="code"><div class="wrapper">  plainValue: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">var</span> parts = parseTextWithTags(value);
    <span class="hljs-keyword">return</span> parts.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(part)</span> </span>{
      <span class="hljs-keyword">if</span> (part.type === <span class="hljs-string">'text'</span>) {
        <span class="hljs-keyword">return</span> part.value;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> LEFT_PAD + noBreak(<span class="hljs-keyword">this</span>.prettyLabel(part.value)) + RIGHT_PAD;
      }
    }.bind(<span class="hljs-keyword">this</span>)).join(<span class="hljs-string">''</span>);
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Given the actual value of the field (with tags), get the html used to
highlight the labels.</p></div></div><div class="code"><div class="wrapper">  prettyValue: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">var</span> parts = parseTextWithTags(value);
    <span class="hljs-keyword">return</span> parts.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(part, i)</span> </span>{
      <span class="hljs-keyword">if</span> (part.type === <span class="hljs-string">'text'</span>) {
        <span class="hljs-keyword">if</span> (i === (parts.length - <span class="hljs-number">1</span>)) {
          <span class="hljs-keyword">if</span> (part.value[part.value.length - <span class="hljs-number">1</span>] === <span class="hljs-string">'\n'</span>) {
            <span class="hljs-keyword">return</span> part.value + <span class="hljs-string">'\u00a0'</span>;
          }
        }
        <span class="hljs-keyword">return</span> part.value;
      } <span class="hljs-keyword">else</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Make a pill</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">var</span> pillRef = <span class="hljs-string">'prettyPart'</span> + i;
        <span class="hljs-keyword">var</span> className = <span class="hljs-string">'pretty-part'</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.hoverPillRef &amp;&amp; pillRef === <span class="hljs-keyword">this</span>.state.hoverPillRef) {
          className += <span class="hljs-string">' pretty-part-hover'</span>;
        }
        <span class="hljs-keyword">return</span> R.span({key: i, className: className, ref: pillRef, <span class="hljs-string">'data-pretty'</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">'data-ref'</span>: pillRef},
          R.span({className: <span class="hljs-string">'pretty-part-left'</span>}, LEFT_PAD),
          R.span({className: <span class="hljs-string">'pretty-part-text'</span>}, noBreak(<span class="hljs-keyword">this</span>.prettyLabel(part.value))),
          R.span({className: <span class="hljs-string">'pretty-part-right'</span>}, RIGHT_PAD)
        );
      }
    }.bind(<span class="hljs-keyword">this</span>));
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Given the tokens for a field, get the actual value of the field (with
tags)</p></div></div><div class="code"><div class="wrapper">  rawValue: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(tokens)</span> </span>{
    <span class="hljs-keyword">return</span> tokens.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(token)</span> </span>{
      <span class="hljs-keyword">if</span> (token.type === <span class="hljs-string">'tag'</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">'{{'</span> + token.value + <span class="hljs-string">'}}'</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> token;
      }
    }).join(<span class="hljs-string">''</span>);
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Given a position, if it&#39;s on a label, get the position left or right of
the label, based on direction and/or which side is closer</p></div></div><div class="code"><div class="wrapper">  moveOffTag: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(pos, tokens, indexMap, dir)</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> dir === <span class="hljs-string">'undefined'</span> || dir &gt; <span class="hljs-number">0</span>) {
      dir = <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
      dir = -<span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">var</span> token;
    <span class="hljs-keyword">if</span> (dir &gt; <span class="hljs-number">0</span>) {
      token = tokens[indexMap[pos]];
      <span class="hljs-keyword">while</span> (pos &lt; indexMap.length &amp;&amp; tokens[indexMap[pos]].type === <span class="hljs-string">'tag'</span> &amp;&amp; tokens[indexMap[pos]] === token) {
        pos++;
      }
    } <span class="hljs-keyword">else</span> {
      token = tokens[indexMap[pos - <span class="hljs-number">1</span>]];
      <span class="hljs-keyword">while</span> (pos &gt; <span class="hljs-number">0</span> &amp;&amp; tokens[indexMap[pos - <span class="hljs-number">1</span>]].type === <span class="hljs-string">'tag'</span> &amp;&amp; tokens[indexMap[pos - <span class="hljs-number">1</span>]] === token) {
        pos--;
      }
    }

    <span class="hljs-keyword">return</span> pos;
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the token at some position.</p></div></div><div class="code"><div class="wrapper">  tokenAt: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(pos)</span> </span>{
    <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-keyword">this</span>.tracking.indexMap.length) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    <span class="hljs-keyword">if</span> (pos &lt; <span class="hljs-number">0</span>) {
      pos = <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.tracking.tokens[<span class="hljs-keyword">this</span>.tracking.indexMap[pos]];
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the token immediately before some position.</p></div></div><div class="code"><div class="wrapper">  tokenBefore: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(pos)</span> </span>{
    <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-keyword">this</span>.tracking.indexMap.length) {
      pos = <span class="hljs-keyword">this</span>.tracking.indexMap.length;
    }
    <span class="hljs-keyword">if</span> (pos &lt;= <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.tracking.tokens[<span class="hljs-keyword">this</span>.tracking.indexMap[pos - <span class="hljs-number">1</span>]];
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Given a position, get a corrected position (if necessary to be
corrected).</p></div></div><div class="code"><div class="wrapper">  normalizePosition: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(pos, prevPos)</span> </span>{
    <span class="hljs-keyword">if</span> (_.isUndefined(prevPos)) {
      prevPos = pos;
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>At start or end, so okay.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (pos &lt;= <span class="hljs-number">0</span> || pos &gt;= <span class="hljs-keyword">this</span>.tracking.indexMap.length) {
      <span class="hljs-keyword">if</span> (pos &lt; <span class="hljs-number">0</span>) {
        pos = <span class="hljs-number">0</span>;
      }
      <span class="hljs-keyword">if</span> (pos &gt; <span class="hljs-keyword">this</span>.tracking.indexMap.length) {
        pos = <span class="hljs-keyword">this</span>.tracking.indexMap.length;
      }
      <span class="hljs-keyword">return</span> pos;
    }

    <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">this</span>.tokenAt(pos);
    <span class="hljs-keyword">var</span> tokenBefore = <span class="hljs-keyword">this</span>.tokenBefore(pos);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Between two tokens, so okay.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (token !== tokenBefore) {
      <span class="hljs-keyword">return</span> pos;
    }

    <span class="hljs-keyword">var</span> prevToken = <span class="hljs-keyword">this</span>.tokenAt(prevPos);
    <span class="hljs-keyword">var</span> prevTokenBefore = <span class="hljs-keyword">this</span>.tokenBefore(prevPos);

    <span class="hljs-keyword">var</span> rightPos = <span class="hljs-keyword">this</span>.moveOffTag(pos, <span class="hljs-keyword">this</span>.tracking.tokens, <span class="hljs-keyword">this</span>.tracking.indexMap);
    <span class="hljs-keyword">var</span> leftPos = <span class="hljs-keyword">this</span>.moveOffTag(pos, <span class="hljs-keyword">this</span>.tracking.tokens, <span class="hljs-keyword">this</span>.tracking.indexMap, -<span class="hljs-number">1</span>);

    <span class="hljs-keyword">if</span> (prevToken !== prevTokenBefore) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Moved from left edge.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (prevToken === token) {
        <span class="hljs-keyword">return</span> rightPos;
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Moved from right edge.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (prevTokenBefore === token) {
        <span class="hljs-keyword">return</span> leftPos;
      }
    }

    <span class="hljs-keyword">var</span> newPos = rightPos;

    <span class="hljs-keyword">if</span> (pos === prevPos || pos &lt; prevPos) {
      <span class="hljs-keyword">if</span> (rightPos - pos &gt; pos - leftPos) {
        newPos = leftPos;
      }
    }
    <span class="hljs-keyword">return</span> newPos;
  },



  onSelect: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
    <span class="hljs-keyword">var</span> node = event.target;

    <span class="hljs-keyword">var</span> pos = node.selectionStart;
    <span class="hljs-keyword">var</span> endPos = node.selectionEnd;

    <span class="hljs-keyword">if</span> (pos === endPos &amp;&amp; <span class="hljs-keyword">this</span>.state.hoverPillRef) {
      <span class="hljs-keyword">var</span> tokenAt = <span class="hljs-keyword">this</span>.tokenAt(pos);
      <span class="hljs-keyword">var</span> tokenBefore = <span class="hljs-keyword">this</span>.tokenBefore(pos);

      <span class="hljs-keyword">if</span> (tokenAt &amp;&amp; tokenAt === tokenBefore &amp;&amp; tokenAt.type &amp;&amp; tokenAt.type === <span class="hljs-string">'tag'</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Clicked a tag.</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">var</span> rightPos = <span class="hljs-keyword">this</span>.moveOffTag(pos, <span class="hljs-keyword">this</span>.tracking.tokens, <span class="hljs-keyword">this</span>.tracking.indexMap);
        <span class="hljs-keyword">var</span> leftPos = <span class="hljs-keyword">this</span>.moveOffTag(pos, <span class="hljs-keyword">this</span>.tracking.tokens, <span class="hljs-keyword">this</span>.tracking.indexMap, -<span class="hljs-number">1</span>);
        <span class="hljs-keyword">this</span>.tracking.pos = leftPos;
        <span class="hljs-keyword">this</span>.tracking.range = rightPos - leftPos;
        node.selectionStart = leftPos;
        node.selectionEnd = rightPos;

        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.state.isChoicesOpen) {
          <span class="hljs-keyword">this</span>.setChoicesOpen(<span class="hljs-literal">true</span>);
        }

        <span class="hljs-keyword">return</span>;
      }
    }

    pos = <span class="hljs-keyword">this</span>.normalizePosition(pos, <span class="hljs-keyword">this</span>.tracking.pos);
    endPos = <span class="hljs-keyword">this</span>.normalizePosition(endPos, <span class="hljs-keyword">this</span>.tracking.pos + <span class="hljs-keyword">this</span>.tracking.range);

    <span class="hljs-keyword">this</span>.tracking.pos = pos;
    <span class="hljs-keyword">this</span>.tracking.range = endPos - pos;

    node.selectionStart = pos;
    node.selectionEnd = endPos;
  },

  onCopy: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> node = <span class="hljs-keyword">this</span>.refs.content.getDOMNode();
    <span class="hljs-keyword">var</span> start = node.selectionStart;
    <span class="hljs-keyword">var</span> end = node.selectionEnd;
    <span class="hljs-keyword">var</span> text = node.value.substring(start, end);
    <span class="hljs-keyword">var</span> realStartIndex = <span class="hljs-keyword">this</span>.tokenIndex(start, <span class="hljs-keyword">this</span>.tracking.tokens, <span class="hljs-keyword">this</span>.tracking.indexMap);
    <span class="hljs-keyword">var</span> realEndIndex = <span class="hljs-keyword">this</span>.tokenIndex(end, <span class="hljs-keyword">this</span>.tracking.tokens, <span class="hljs-keyword">this</span>.tracking.indexMap);
    <span class="hljs-keyword">var</span> tokens = <span class="hljs-keyword">this</span>.tracking.tokens.slice(realStartIndex, realEndIndex);
    text = <span class="hljs-keyword">this</span>.rawValue(tokens);
    <span class="hljs-keyword">var</span> originalValue = node.value;
    node.value = node.value + text;
    node.setSelectionRange(originalValue.length, originalValue.length + text.length);
    <span class="hljs-built_in">window</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      node.value = originalValue;
      node.setSelectionRange(start, end);
    }, <span class="hljs-number">0</span>);
  },

  onCut: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> node = <span class="hljs-keyword">this</span>.refs.content.getDOMNode();
    <span class="hljs-keyword">var</span> start = node.selectionStart;
    <span class="hljs-keyword">var</span> end = node.selectionEnd;
    <span class="hljs-keyword">var</span> text = node.value.substring(start, end);
    <span class="hljs-keyword">var</span> realStartIndex = <span class="hljs-keyword">this</span>.tokenIndex(start, <span class="hljs-keyword">this</span>.tracking.tokens, <span class="hljs-keyword">this</span>.tracking.indexMap);
    <span class="hljs-keyword">var</span> realEndIndex = <span class="hljs-keyword">this</span>.tokenIndex(end, <span class="hljs-keyword">this</span>.tracking.tokens, <span class="hljs-keyword">this</span>.tracking.indexMap);
    <span class="hljs-keyword">var</span> tokens = <span class="hljs-keyword">this</span>.tracking.tokens.slice(realStartIndex, realEndIndex);
    text = <span class="hljs-keyword">this</span>.rawValue(tokens);
    <span class="hljs-keyword">var</span> originalValue = node.value;
    <span class="hljs-keyword">var</span> cutValue = node.value.substring(<span class="hljs-number">0</span>, start) + node.value.substring(end);
    node.value = node.value + text;
    node.setSelectionRange(originalValue.length, originalValue.length + text.length);
    <span class="hljs-keyword">var</span> cutTokens = <span class="hljs-keyword">this</span>.tracking.tokens.slice(<span class="hljs-number">0</span>, realStartIndex).concat(<span class="hljs-keyword">this</span>.tracking.tokens.slice(realEndIndex));
    <span class="hljs-built_in">window</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      node.value = cutValue;
      node.setSelectionRange(start, start);
      <span class="hljs-keyword">this</span>.tracking.pos = start;
      <span class="hljs-keyword">this</span>.tracking.range = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">this</span>.tracking.tokens = cutTokens;
      <span class="hljs-keyword">this</span>.tracking.indexMap = <span class="hljs-keyword">this</span>.indexMap(<span class="hljs-keyword">this</span>.tracking.tokens);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Convert tokens back into raw value with tags. Newly formed tags will
become part of the raw value.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">var</span> rawValue = <span class="hljs-keyword">this</span>.rawValue(<span class="hljs-keyword">this</span>.tracking.tokens);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set the value to the new raw value.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">this</span>.onChangeValue(rawValue);

      <span class="hljs-keyword">this</span>.snapshot();
    }.bind(<span class="hljs-keyword">this</span>), <span class="hljs-number">0</span>);
  },

  onKeyDown: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{

    <span class="hljs-keyword">if</span> (event.keyCode === <span class="hljs-number">37</span>) {
      <span class="hljs-keyword">this</span>.leftArrowDown = <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.keyCode === <span class="hljs-number">39</span>) {
      <span class="hljs-keyword">this</span>.rightArrowDown = <span class="hljs-literal">true</span>;
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Cmd-Z or Ctrl-Z</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (event.keyCode === <span class="hljs-number">90</span> &amp;&amp; (event.metaKey || event.ctrlKey) &amp;&amp; !event.shiftKey) {
      event.preventDefault();
      <span class="hljs-keyword">this</span>.undo();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Cmd-Shift-Z or Ctrl-Y</p></div></div><div class="code"><div class="wrapper">    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
      (event.keyCode === <span class="hljs-number">89</span> &amp;&amp; event.ctrlKey &amp;&amp; !event.shiftKey) ||
      (event.keyCode === <span class="hljs-number">90</span> &amp;&amp; event.metaKey &amp;&amp; event.shiftKey)
    ) {
      <span class="hljs-keyword">this</span>.redo();
    }
  },

  onKeyUp: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
    <span class="hljs-keyword">if</span> (event.keyCode === <span class="hljs-number">37</span>) {
      <span class="hljs-keyword">this</span>.leftArrowDown = <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.keyCode === <span class="hljs-number">39</span>) {
      <span class="hljs-keyword">this</span>.rightArrowDown = <span class="hljs-literal">false</span>;
    }
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Keep the highlight styles in sync with the textarea styles.</p></div></div><div class="code"><div class="wrapper">  adjustStyles: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(isMount)</span> </span>{
    <span class="hljs-keyword">var</span> overlay = <span class="hljs-keyword">this</span>.refs.highlight.getDOMNode();
    <span class="hljs-keyword">var</span> content = <span class="hljs-keyword">this</span>.refs.content.getDOMNode();

    <span class="hljs-keyword">var</span> style = <span class="hljs-built_in">window</span>.getComputedStyle(content);

    <span class="hljs-keyword">var</span> backgroundColor = style.backgroundColor;

    utils.copyElementStyle(content, overlay);

    overlay.style.position = <span class="hljs-string">'absolute'</span>;
    overlay.style.whiteSpace = <span class="hljs-string">'pre-wrap'</span>;
    overlay.style.color = <span class="hljs-string">'rgba(0,0,0,0)'</span>;
    overlay.style.webkitTextFillColor = <span class="hljs-string">'rgba(0,0,0,0)'</span>;
    overlay.style.resize = <span class="hljs-string">'none'</span>;
    overlay.style.borderColor = <span class="hljs-string">'rgba(0,0,0,0)'</span>;

    <span class="hljs-keyword">if</span> (utils.browser.isMozilla) {

      <span class="hljs-keyword">var</span> paddingTop = <span class="hljs-built_in">parseFloat</span>(style.paddingTop);
      <span class="hljs-keyword">var</span> paddingBottom = <span class="hljs-built_in">parseFloat</span>(style.paddingBottom);

      <span class="hljs-keyword">var</span> borderTop = <span class="hljs-built_in">parseFloat</span>(style.borderTopWidth);
      <span class="hljs-keyword">var</span> borderBottom = <span class="hljs-built_in">parseFloat</span>(style.borderBottomWidth);

      overlay.style.paddingTop = <span class="hljs-string">'0px'</span>;
      overlay.style.paddingBottom = <span class="hljs-string">'0px'</span>;

      overlay.style.height = (content.clientHeight - paddingTop - paddingBottom + borderTop + borderBottom) + <span class="hljs-string">'px'</span>;
      overlay.style.top = style.paddingTop;
      overlay.style.boxShadow = <span class="hljs-string">'none'</span>;
    }

    <span class="hljs-keyword">if</span> (isMount) {
      <span class="hljs-keyword">this</span>.backgroundColor = backgroundColor;
    }
    overlay.style.backgroundColor = <span class="hljs-keyword">this</span>.backgroundColor;
    content.style.backgroundColor = <span class="hljs-string">'rgba(0,0,0,0)'</span>;
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the textarea is resized, need to re-sync the styles.</p></div></div><div class="code"><div class="wrapper">  onResize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.adjustStyles();
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the window is resized, may need to re-sync the styles.
Probably not necessary with element resize?</p></div></div><div class="code"><div class="wrapper">  onResizeWindow: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.adjustStyles();
  },

  componentDidMount: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.adjustStyles(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">this</span>.setOnResize(<span class="hljs-string">'content'</span>, <span class="hljs-keyword">this</span>.onResize);
    <span class="hljs-comment">//this.setOnClickOutside('choices', this.onClickOutsideChoices);</span>
  },

  onInsertFromSelect: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
    <span class="hljs-keyword">if</span> (event.target.selectedIndex &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">var</span> tag = event.target.value;
      event.target.selectedIndex = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">var</span> pos = <span class="hljs-keyword">this</span>.tracking.pos;
      <span class="hljs-keyword">var</span> insertPos = <span class="hljs-keyword">this</span>.normalizePosition(pos);
      <span class="hljs-keyword">var</span> tokens = <span class="hljs-keyword">this</span>.tracking.tokens;
      <span class="hljs-keyword">var</span> tokenIndex = <span class="hljs-keyword">this</span>.tokenIndex(insertPos, tokens, <span class="hljs-keyword">this</span>.tracking.indexMap);
      tokens.splice(tokenIndex, <span class="hljs-number">0</span>, {
        type: <span class="hljs-string">'tag'</span>,
        value: tag
      });
      <span class="hljs-keyword">this</span>.tracking.indexMap = <span class="hljs-keyword">this</span>.indexMap(tokens);
      <span class="hljs-keyword">var</span> newValue = <span class="hljs-keyword">this</span>.rawValue(tokens);
      <span class="hljs-keyword">this</span>.tracking.pos += <span class="hljs-keyword">this</span>.prettyLabel(tag).length;
      <span class="hljs-keyword">this</span>.onChangeValue(newValue);
      <span class="hljs-keyword">this</span>.refs.content.getDOMNode().focus();
    }
  },

  onInsert: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">var</span> tag = value;
    <span class="hljs-keyword">var</span> pos = <span class="hljs-keyword">this</span>.tracking.pos;
    <span class="hljs-keyword">var</span> endPos = <span class="hljs-keyword">this</span>.tracking.pos + <span class="hljs-keyword">this</span>.tracking.range;
    <span class="hljs-keyword">var</span> insertPos = <span class="hljs-keyword">this</span>.normalizePosition(pos);
    <span class="hljs-keyword">var</span> endInsertPos = <span class="hljs-keyword">this</span>.normalizePosition(endPos);
    <span class="hljs-keyword">var</span> tokens = <span class="hljs-keyword">this</span>.tracking.tokens;
    <span class="hljs-keyword">var</span> tokenIndex = <span class="hljs-keyword">this</span>.tokenIndex(insertPos, tokens, <span class="hljs-keyword">this</span>.tracking.indexMap);
    <span class="hljs-keyword">var</span> tokenEndIndex = <span class="hljs-keyword">this</span>.tokenIndex(endInsertPos, tokens, <span class="hljs-keyword">this</span>.tracking.indexMap);
    tokens.splice(tokenIndex, tokenEndIndex - tokenIndex, {
      type: <span class="hljs-string">'tag'</span>,
      value: tag
    });
    <span class="hljs-keyword">this</span>.tracking.indexMap = <span class="hljs-keyword">this</span>.indexMap(tokens);
    <span class="hljs-keyword">var</span> newValue = <span class="hljs-keyword">this</span>.rawValue(tokens);
    <span class="hljs-keyword">this</span>.tracking.pos += <span class="hljs-keyword">this</span>.prettyLabel(tag).length;
    <span class="hljs-keyword">this</span>.onChangeValue(newValue);
    <span class="hljs-keyword">this</span>.setState({
      isChoicesOpen: <span class="hljs-literal">false</span>
    });
    <span class="hljs-keyword">this</span>.refs.content.getDOMNode().focus();
  },

  onToggleChoices: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.setChoicesOpen(!<span class="hljs-keyword">this</span>.state.isChoicesOpen);
  },

  onCloseChoices: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.isChoicesOpen) {
      <span class="hljs-keyword">this</span>.setChoicesOpen(<span class="hljs-literal">false</span>);
    }
  },

  setChoicesOpen: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(isOpen)</span> </span>{
    <span class="hljs-keyword">if</span> (isOpen) {
      <span class="hljs-keyword">this</span>.onStartAction(<span class="hljs-string">'open-replacements'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.onStartAction(<span class="hljs-string">'close-replacements'</span>);
    }
    <span class="hljs-keyword">this</span>.setState({
      isChoicesOpen: isOpen
    });
  },

  closeChoices: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

  },

  getCloseIgnoreNodes: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.refs.toggle.getDOMNode();
  },

  onClickOutsideChoices: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>// If we didn&#39;t click on the toggle button, close the choices.
if (this.isNodeOutside(this.refs.toggle.getDOMNode(), event.target)) {
  console.log(&#39;not a toggle click&#39;)
  this.setState({
    isChoicesOpen: false
  });</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-comment">// </span>
  },

  onMouseMove: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Placeholder to get at pill under mouse position. Inefficient, but not
sure there&#39;s another way.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> position = {x: event.clientX, y: event.clientY};
    <span class="hljs-keyword">var</span> nodes = <span class="hljs-keyword">this</span>.refs.highlight.getDOMNode().childNodes;
    <span class="hljs-keyword">var</span> matchedNode = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; nodes.length; i++) {
      <span class="hljs-keyword">var</span> node = nodes[i];
      <span class="hljs-keyword">if</span> (nodes[i].getAttribute(<span class="hljs-string">'data-pretty'</span>)) {
        <span class="hljs-keyword">if</span> (positionInNode(position, node)) {
          matchedNode = node;
          <span class="hljs-keyword">break</span>;
        }
      }
    }

    <span class="hljs-keyword">if</span> (matchedNode) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.hoverPillRef !== matchedNode.getAttribute(<span class="hljs-string">'data-ref'</span>)) {
        <span class="hljs-keyword">this</span>.setState({
          hoverPillRef: matchedNode.getAttribute(<span class="hljs-string">'data-ref'</span>)
        });
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.hoverPillRef) {
      <span class="hljs-keyword">this</span>.setState({
        hoverPillRef: <span class="hljs-literal">null</span>
      });
    }
  },

  render: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.renderWithConfig();
  },

  renderDefault: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> config = <span class="hljs-keyword">this</span>.props.config;
    <span class="hljs-keyword">var</span> field = <span class="hljs-keyword">this</span>.props.field;

    <span class="hljs-keyword">var</span> replaceChoices = <span class="hljs-keyword">this</span>.state.replaceChoices;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>var selectReplaceChoices = [{
  value: &#39;&#39;,
  label: &#39;Insert...&#39;</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-comment">// ].concat(replaceChoices);</span>

    <span class="hljs-keyword">return</span> config.createElement(<span class="hljs-string">'field'</span>, {
      field: field, plain: <span class="hljs-keyword">this</span>.props.plain
    }, R.div({style: {position: <span class="hljs-string">'relative'</span>}},

      R.pre({
        className: <span class="hljs-string">'pretty-highlight'</span>,
        ref: <span class="hljs-string">'highlight'</span>
      },
        <span class="hljs-keyword">this</span>.prettyValue(<span class="hljs-keyword">this</span>.props.field.value)
      ),

      (config.fieldIsSingleLine(field) ? R.input : R.textarea)({
        type: <span class="hljs-string">'text'</span>,
        className: cx(_.extend({}, <span class="hljs-keyword">this</span>.props.classes, {<span class="hljs-string">'pretty-content'</span>: <span class="hljs-literal">true</span>})),
        ref: <span class="hljs-string">'content'</span>,
        rows: field.rows || <span class="hljs-keyword">this</span>.props.rows,
        name: field.key,
        value: <span class="hljs-keyword">this</span>.plainValue(<span class="hljs-keyword">this</span>.props.field.value),
        onChange: <span class="hljs-keyword">this</span>.onChange,
        onScroll: <span class="hljs-keyword">this</span>.onScroll,
        style: {
          position: <span class="hljs-string">'relative'</span>,
          top: <span class="hljs-number">0</span>,
          left: <span class="hljs-number">0</span>,
          cursor: <span class="hljs-keyword">this</span>.state.hoverPillRef ? <span class="hljs-string">'pointer'</span> : <span class="hljs-literal">null</span>
        },
        onKeyPress: <span class="hljs-keyword">this</span>.onKeyPress,
        onKeyDown: <span class="hljs-keyword">this</span>.onKeyDown,
        onKeyUp: <span class="hljs-keyword">this</span>.onKeyUp,
        onSelect: <span class="hljs-keyword">this</span>.onSelect,
        onCopy: <span class="hljs-keyword">this</span>.onCopy,
        onCut: <span class="hljs-keyword">this</span>.onCut,
        onMouseMove: <span class="hljs-keyword">this</span>.onMouseMove,
        onFocus: <span class="hljs-keyword">this</span>.onFocusAction,
        onBlur: <span class="hljs-keyword">this</span>.onBlurAction
      }),

      R.a({ref: <span class="hljs-string">'toggle'</span>, href: <span class="hljs-string">'JavaScript'</span> + <span class="hljs-string">':'</span>, onClick: <span class="hljs-keyword">this</span>.onToggleChoices}, <span class="hljs-string">'Insert...'</span>),

      config.createElement(<span class="hljs-string">'choices'</span>, {
        ref: <span class="hljs-string">'choices'</span>,
        choices: replaceChoices, open: <span class="hljs-keyword">this</span>.state.isChoicesOpen,
        onSelect: <span class="hljs-keyword">this</span>.onInsert, onClose: <span class="hljs-keyword">this</span>.onCloseChoices, ignoreCloseNodes: <span class="hljs-keyword">this</span>.getCloseIgnoreNodes
      })
    ));
  }
});</div></div></div></div></body></html>