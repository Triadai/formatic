<!DOCTYPE html><html lang="en"><head><title>plugins/reference</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="plugins/reference"><meta name="groc-project-path" content="lib/plugins/reference.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/plugins/reference.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="reference-plugin">reference plugin</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This plugin allows fields to be strings and reference other fields by key or
id. It also allows a field to extend another field with
extends: [&#39;foo&#39;, &#39;bar&#39;] where &#39;foo&#39; and &#39;bar&#39; refer to other keys or ids.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-pi">
'use strict'</span>;

<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>);

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(config)</span> {</span>

  <span class="hljs-keyword">var</span> initField = config.initField;

  <span class="hljs-keyword">return</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Look for a template in this field or any of its parents.</p></div></div><div class="code"><div class="wrapper">    findFieldTemplate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(field, name)</span> {</span>

      <span class="hljs-keyword">if</span> (field.templates[name]) {
        <span class="hljs-keyword">return</span> field.templates[name];
      }

      <span class="hljs-keyword">if</span> (field.parent) {
        <span class="hljs-keyword">return</span> config.findFieldTemplate(field.parent, name);
      }

      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Inherit from any field templates that this field template
extends.</p></div></div><div class="code"><div class="wrapper">    resolveFieldTemplate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(field, fieldTemplate)</span> {</span>

      <span class="hljs-keyword">if</span> (!fieldTemplate.extends) {
        <span class="hljs-keyword">return</span> fieldTemplate;
      }

      <span class="hljs-keyword">var</span> ext = fieldTemplate.extends;

      <span class="hljs-keyword">if</span> (!_.isArray(ext)) {
        ext = [ext];
      }

      <span class="hljs-keyword">var</span> bases = ext.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(base)</span> {</span>
        <span class="hljs-keyword">var</span> template = config.findFieldTemplate(field, base);
        <span class="hljs-keyword">if</span> (!template) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Template '</span> + base + <span class="hljs-string">' not found.'</span>);
        }
        <span class="hljs-keyword">return</span> template;
      });

      <span class="hljs-keyword">var</span> chain = [{}].concat(bases.reverse().concat([fieldTemplate]));
      fieldTemplate = _.extend.apply(_, chain);

      <span class="hljs-keyword">return</span> fieldTemplate;
    },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Wrap the initField method.</p></div></div><div class="code"><div class="wrapper">    initField: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(field)</span> {</span>

      <span class="hljs-keyword">var</span> templates = field.templates = {};

      <span class="hljs-keyword">var</span> childFieldTemplates = config.fieldChildFieldTemplates(field);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add each of the child field templates to our template map.</p></div></div><div class="code"><div class="wrapper">      childFieldTemplates.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fieldTemplate)</span> {</span>

        <span class="hljs-keyword">if</span> (_.isString(fieldTemplate)) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">var</span> key = fieldTemplate.key;
        <span class="hljs-keyword">var</span> id = fieldTemplate.id;

        <span class="hljs-keyword">if</span> (fieldTemplate.template) {
          fieldTemplate = _.extend({}, fieldTemplate, {template: <span class="hljs-literal">false</span>});
        }

        <span class="hljs-keyword">if</span> (!_.isUndefined(key) &amp;&amp; key !== <span class="hljs-string">''</span>) {
          templates[key] = fieldTemplate;
        }

        <span class="hljs-keyword">if</span> (!_.isUndefined(id) &amp;&amp; id !== <span class="hljs-string">''</span>) {
          templates[id] = fieldTemplate;
        }
      });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Resolve any references to other field templates.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (childFieldTemplates.length &gt; <span class="hljs-number">0</span>) {
        field.fields = childFieldTemplates.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fieldTemplate)</span> {</span>
          <span class="hljs-keyword">if</span> (_.isString(fieldTemplate)) {
            fieldTemplate = config.findFieldTemplate(field, fieldTemplate);
          }

          <span class="hljs-keyword">return</span> config.resolveFieldTemplate(field, fieldTemplate);
        });

        field.fields = field.fields.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fieldTemplate)</span> {</span>
          <span class="hljs-keyword">return</span> !fieldTemplate.template;
        });
      }

      <span class="hljs-keyword">var</span> itemFieldTemplates = config.fieldItemFieldTemplates(field);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Resolve any of our item field templates. (Field templates for dynamic
child fields.)</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (itemFieldTemplates.length &gt; <span class="hljs-number">0</span>) {
        field.itemFields = itemFieldTemplates.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(itemFieldTemplate)</span> {</span>
          <span class="hljs-keyword">if</span> (_.isString(itemFieldTemplate)) {
            itemFieldTemplate = config.findFieldTemplate(field, itemFieldTemplate);
          }

          <span class="hljs-keyword">return</span> config.resolveFieldTemplate(field, itemFieldTemplate);
        });
      }

      initField(field);
    }
  };

};</div></div></div></div></body></html>